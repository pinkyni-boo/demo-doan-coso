# Há»‡ Thá»‘ng ThÃ´ng BÃ¡o (Notification System)

## ğŸ“‹ Tá»•ng Quan

Há»‡ thá»‘ng thÃ´ng bÃ¡o toÃ n diá»‡n cho á»©ng dá»¥ng quáº£n lÃ½ phÃ²ng gym, há»— trá»£ gá»­i thÃ´ng bÃ¡o real-time Ä‘áº¿n User vÃ  Trainer vá» cÃ¡c sá»± kiá»‡n quan trá»ng nhÆ° thanh toÃ¡n, Ä‘Äƒng kÃ½ lá»›p há»c, Ä‘iá»ƒm danh, vÃ  cÃ¡c hoáº¡t Ä‘á»™ng khÃ¡c.

---

## ğŸ¯ CÃ¡c Loáº¡i ThÃ´ng BÃ¡o

### 1. ThÃ´ng BÃ¡o Cho User (Member)

#### 1.1 Thanh ToÃ¡n (Payment Notifications)

**a) Thanh toÃ¡n Ä‘Æ°á»£c cháº¥p nháº­n**

```
âœ… Thanh toÃ¡n thÃ nh cÃ´ng
ğŸ’° Thanh toÃ¡n [sá»‘ tiá»n]Ä‘ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n.
ğŸ“ Chi tiáº¿t: [GÃ³i thÃ nh viÃªn / Lá»›p há»c]
ğŸ‰ Báº¡n Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ táº­p luyá»‡n!
```

**b) Thanh toÃ¡n bá»‹ tá»« chá»‘i**

```
âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i
ğŸ’° Thanh toÃ¡n [sá»‘ tiá»n]Ä‘ cá»§a báº¡n Ä‘Ã£ bá»‹ tá»« chá»‘i.
ğŸ“ LÃ½ do: [LÃ½ do cá»¥ thá»ƒ tá»« admin]
ğŸ”„ HÃ nh Ä‘á»™ng: Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin vÃ  thanh toÃ¡n láº¡i
ğŸ“ Há»— trá»£: LiÃªn há»‡ admin náº¿u cáº§n trá»£ giÃºp
```

**c) Thanh toÃ¡n Ä‘ang chá» xá»­ lÃ½**

```
â³ Thanh toÃ¡n Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½
ğŸ’° ChÃºng tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c yÃªu cáº§u thanh toÃ¡n [sá»‘ tiá»n]Ä‘
â±ï¸ Admin Ä‘ang xem xÃ©t, vui lÃ²ng chá» trong 24h
```

#### 1.2 ÄÄƒng KÃ½ Lá»›p Há»c (Class Enrollment)

**a) ÄÄƒng kÃ½ thÃ nh cÃ´ng**

```
ğŸ“ ÄÄƒng kÃ½ lá»›p há»c thÃ nh cÃ´ng
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¨â€ğŸ« Huáº¥n luyá»‡n viÃªn: [TÃªn trainer]
ğŸ“… Lá»‹ch há»c: [Thá»i gian]
ğŸ“ PhÃ²ng: [Sá»‘ phÃ²ng]
```

**b) Lá»›p há»c sáº¯p báº¯t Ä‘áº§u (Reminder)**

```
â° Nháº¯c nhá»Ÿ: Lá»›p há»c sáº¯p báº¯t Ä‘áº§u
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ• Thá»i gian: [CÃ²n 30 phÃºt ná»¯a]
ğŸ“ PhÃ²ng: [Sá»‘ phÃ²ng]
ğŸ’ª Chuáº©n bá»‹ sáºµn sÃ ng nhÃ©!
```

**c) Há»§y Ä‘Äƒng kÃ½ lá»›p há»c**

```
âŒ ÄÄƒng kÃ½ lá»›p há»c Ä‘Ã£ bá»‹ há»§y
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“ LÃ½ do: [Thanh toÃ¡n bá»‹ tá»« chá»‘i / Lá»›p Ä‘áº§y]
ğŸ”„ Báº¡n cÃ³ thá»ƒ Ä‘Äƒng kÃ½ lá»›p há»c khÃ¡c
```

#### 1.3 GÃ³i ThÃ nh ViÃªn (Membership)

**a) KÃ­ch hoáº¡t thÃ nh viÃªn**

```
ğŸŠ ChÃ o má»«ng báº¡n trá»Ÿ thÃ nh thÃ nh viÃªn
ğŸ’³ GÃ³i: [Basic/Premium/VIP]
ğŸ“… Hiá»‡u lá»±c: [NgÃ y báº¯t Ä‘áº§u - NgÃ y káº¿t thÃºc]
ğŸ Quyá»n lá»£i: [Danh sÃ¡ch quyá»n lá»£i]
```

**b) GÃ³i thÃ nh viÃªn sáº¯p háº¿t háº¡n**

```
âš ï¸ GÃ³i thÃ nh viÃªn sáº¯p háº¿t háº¡n
ğŸ’³ GÃ³i: [TÃªn gÃ³i]
ğŸ“… Háº¿t háº¡n: [CÃ²n 7 ngÃ y]
ğŸ”„ Gia háº¡n ngay Ä‘á»ƒ tiáº¿p tá»¥c sá»­ dá»¥ng dá»‹ch vá»¥
```

**c) GÃ³i thÃ nh viÃªn Ä‘Ã£ háº¿t háº¡n**

```
âŒ GÃ³i thÃ nh viÃªn Ä‘Ã£ háº¿t háº¡n
ğŸ’³ GÃ³i: [TÃªn gÃ³i]
ğŸ“… Háº¿t háº¡n: [NgÃ y háº¿t háº¡n]
ğŸ”„ Gia háº¡n ngay Ä‘á»ƒ tiáº¿p tá»¥c táº­p luyá»‡n
```

**d) NÃ¢ng cáº¥p gÃ³i thÃ nh viÃªn thÃ nh cÃ´ng**

```
â¬†ï¸ NÃ¢ng cáº¥p gÃ³i thÃ nh cÃ´ng
ğŸ’³ GÃ³i má»›i: [Premium/VIP]
ğŸ Quyá»n lá»£i má»›i: [Danh sÃ¡ch quyá»n lá»£i]
âœ¨ Táº­n hÆ°á»Ÿng dá»‹ch vá»¥ cao cáº¥p!
```

#### 1.4 Äiá»ƒm Danh (Attendance)

**a) Äiá»ƒm danh thÃ nh cÃ´ng**

```
âœ… Äiá»ƒm danh thÃ nh cÃ´ng
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“… Buá»•i há»c: [Sá»‘ buá»•i / Tá»•ng buá»•i]
â­ Tiáº¿p tá»¥c phÃ¡t huy nhÃ©!
```

**b) Váº¯ng máº·t khÃ´ng lÃ½ do**

```
âš ï¸ Ghi nháº­n váº¯ng máº·t
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“… Buá»•i há»c: [NgÃ y thÃ¡ng]
ğŸ“ LÆ°u Ã½: LiÃªn há»‡ trainer náº¿u cÃ³ lÃ½ do chÃ­nh Ä‘Ã¡ng
```

#### 1.5 Pháº£n Há»“i (Feedback)

**a) Pháº£n há»“i Ä‘Æ°á»£c xá»­ lÃ½**

```
ğŸ“¬ Pháº£n há»“i cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c xem xÃ©t
ğŸ“ Ná»™i dung: [TÃ³m táº¯t pháº£n há»“i]
ğŸ’¬ Tráº£ lá»i: [Pháº£n há»“i tá»« admin]
ğŸ™ Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘Ã³ng gÃ³p Ã½ kiáº¿n!
```

### 2. ThÃ´ng BÃ¡o Cho Trainer

#### 2.1 Lá»›p Há»c (Class Management)

**a) Há»c viÃªn má»›i Ä‘Äƒng kÃ½**

```
ğŸ‘¥ Há»c viÃªn má»›i Ä‘Äƒng kÃ½ lá»›p
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¤ Há»c viÃªn: [TÃªn há»c viÃªn]
ğŸ“Š Tá»•ng sá»‘ há»c viÃªn: [Hiá»‡n táº¡i/Tá»‘i Ä‘a]
```

**b) Lá»›p há»c sáº¯p báº¯t Ä‘áº§u**

```
â° Lá»›p há»c sáº¯p báº¯t Ä‘áº§u
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ• Thá»i gian: [CÃ²n 15 phÃºt]
ğŸ“ PhÃ²ng: [Sá»‘ phÃ²ng]
ğŸ‘¥ Sá»‘ há»c viÃªn: [Sá»‘ lÆ°á»£ng]
```

**c) Há»c viÃªn há»§y Ä‘Äƒng kÃ½**

```
âŒ Há»c viÃªn Ä‘Ã£ há»§y Ä‘Äƒng kÃ½
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¤ Há»c viÃªn: [TÃªn há»c viÃªn]
ğŸ“Š Sá»‘ há»c viÃªn cÃ²n láº¡i: [Sá»‘ lÆ°á»£ng]
```

**d) Lá»›p há»c Ä‘Ã£ Ä‘áº§y**

```
âœ… Lá»›p há»c Ä‘Ã£ Ä‘á»§ há»c viÃªn
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¥ Sá»‘ há»c viÃªn: [Tá»‘i Ä‘a]
ğŸ‰ Sáºµn sÃ ng cho khÃ³a há»c!
```

#### 2.2 Äiá»ƒm Danh (Attendance)

**a) Nháº¯c nhá»Ÿ Ä‘iá»ƒm danh**

```
ğŸ“‹ ÄÃ£ Ä‘áº¿n giá» Ä‘iá»ƒm danh
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¥ Sá»‘ há»c viÃªn: [Sá»‘ lÆ°á»£ng]
âœ… Vui lÃ²ng Ä‘iá»ƒm danh cho há»c viÃªn
```

**b) HoÃ n thÃ nh Ä‘iá»ƒm danh**

```
âœ… Äiá»ƒm danh hoÃ n táº¥t
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“Š CÃ³ máº·t: [Sá»‘ lÆ°á»£ng] / [Tá»•ng sá»‘]
ğŸ“… Buá»•i há»c: [Sá»‘ buá»•i]
```

#### 2.3 Lá»‹ch Dáº¡y (Schedule)

**a) Thay Ä‘á»•i lá»‹ch dáº¡y**

```
ğŸ”„ Lá»‹ch dáº¡y cÃ³ thay Ä‘á»•i
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“… Lá»‹ch cÅ©: [Thá»i gian cÅ©]
ğŸ“… Lá»‹ch má»›i: [Thá»i gian má»›i]
ğŸ“ LÃ½ do: [LÃ½ do thay Ä‘á»•i]
```

**b) YÃªu cáº§u thay Ä‘á»•i lá»‹ch Ä‘Æ°á»£c duyá»‡t**

```
âœ… YÃªu cáº§u thay Ä‘á»•i lá»‹ch Ä‘Æ°á»£c cháº¥p nháº­n
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“… Lá»‹ch má»›i: [Thá»i gian má»›i]
ğŸ’¬ Ghi chÃº tá»« admin: [Ghi chÃº]
```

**c) YÃªu cáº§u thay Ä‘á»•i lá»‹ch bá»‹ tá»« chá»‘i**

```
âŒ YÃªu cáº§u thay Ä‘á»•i lá»‹ch bá»‹ tá»« chá»‘i
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ“ LÃ½ do: [LÃ½ do tá»« chá»‘i]
ğŸ’¬ Ghi chÃº: [Ghi chÃº tá»« admin]
```

#### 2.4 Pháº£n Há»“i (Feedback)

**a) Nháº­n pháº£n há»“i tá»« há»c viÃªn**

```
â­ Nháº­n Ä‘Ã¡nh giÃ¡ má»›i tá»« há»c viÃªn
ğŸ“š Lá»›p: [TÃªn lá»›p]
ğŸ‘¤ Há»c viÃªn: [TÃªn há»c viÃªn]
â­ ÄÃ¡nh giÃ¡: [Sá»‘ sao]
ğŸ’¬ Nháº­n xÃ©t: [Ná»™i dung]
```

### 3. ThÃ´ng BÃ¡o Há»‡ Thá»‘ng (System Notifications)

#### 3.1 Báº£o TrÃ¬

```
ğŸ”§ Báº£o trÃ¬ há»‡ thá»‘ng
â° Thá»i gian: [Thá»i gian báº£o trÃ¬]
âš ï¸ áº¢nh hÆ°á»Ÿng: [CÃ¡c chá»©c nÄƒng bá»‹ áº£nh hÆ°á»Ÿng]
ğŸ’¡ Khuyáº¿n nghá»‹: [HÃ nh Ä‘á»™ng nÃªn lÃ m]
```

#### 3.2 Cáº­p Nháº­t

```
ğŸ†• PhiÃªn báº£n má»›i cÃ³ sáºµn
âœ¨ TÃ­nh nÄƒng má»›i: [Danh sÃ¡ch tÃ­nh nÄƒng]
ğŸ”„ Vui lÃ²ng cáº­p nháº­t á»©ng dá»¥ng
```

---

## ğŸ› ï¸ Chá»©c NÄƒng Chi Tiáº¿t

### 1. Gá»­i ThÃ´ng BÃ¡o Tá»± Äá»™ng

#### Khi Admin Tá»« Chá»‘i Thanh ToÃ¡n

```javascript
// Backend: paymentController.js - rejectPayment()
const notification = await Notification.create({
  user: payment.user,
  type: "payment-rejected",
  title: "âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i",
  message: `ğŸ’° Thanh toÃ¡n ${payment.amount.toLocaleString()}Ä‘ cá»§a báº¡n Ä‘Ã£ bá»‹ tá»« chá»‘i...`,
  relatedId: payment._id,
  isRead: false,
});
```

#### Khi Há»c ViÃªn ÄÄƒng KÃ½ Lá»›p

```javascript
// Gá»­i thÃ´ng bÃ¡o cho User
await Notification.create({
  user: userId,
  type: "class-enrolled",
  title: "ğŸ“ ÄÄƒng kÃ½ lá»›p há»c thÃ nh cÃ´ng",
  message: `Báº¡n Ä‘Ã£ Ä‘Äƒng kÃ½ lá»›p ${className}...`,
});

// Gá»­i thÃ´ng bÃ¡o cho Trainer
await Notification.create({
  user: trainerId,
  type: "new-student",
  title: "ğŸ‘¥ Há»c viÃªn má»›i Ä‘Äƒng kÃ½ lá»›p",
  message: `${studentName} Ä‘Ã£ Ä‘Äƒng kÃ½ lá»›p ${className}...`,
});
```

#### Khi Äiá»ƒm Danh

```javascript
// Gá»­i cho há»c viÃªn
await Notification.create({
  user: studentId,
  type: "attendance-marked",
  title: "âœ… Äiá»ƒm danh thÃ nh cÃ´ng",
  message: `Buá»•i há»c ${sessionNumber}/${totalSessions}...`,
});
```

### 2. API Endpoints

#### 2.1 Láº¥y Danh SÃ¡ch ThÃ´ng BÃ¡o

```http
GET /api/notifications
Authorization: Bearer [token]
Query Parameters:
  - page: number (default: 1)
  - limit: number (default: 20)
  - type: string (optional) - Lá»c theo loáº¡i
  - isRead: boolean (optional) - Lá»c theo tráº¡ng thÃ¡i Ä‘á»c

Response:
{
  "notifications": [
    {
      "_id": "notification_id",
      "user": "user_id",
      "type": "payment-rejected",
      "title": "âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i",
      "message": "...",
      "relatedId": "payment_id",
      "isRead": false,
      "createdAt": "2025-10-28T...",
      "updatedAt": "2025-10-28T..."
    }
  ],
  "unreadCount": 5,
  "totalCount": 25,
  "currentPage": 1,
  "totalPages": 2
}
```

#### 2.2 ÄÃ¡nh Dáº¥u ÄÃ£ Äá»c

```http
PUT /api/notifications/:id/read
Authorization: Bearer [token]

Response:
{
  "success": true,
  "message": "ÄÃ£ Ä‘Ã¡nh dáº¥u thÃ´ng bÃ¡o lÃ  Ä‘Ã£ Ä‘á»c",
  "notification": { ... }
}
```

#### 2.3 ÄÃ¡nh Dáº¥u Táº¥t Cáº£ ÄÃ£ Äá»c

```http
PUT /api/notifications/mark-all-read
Authorization: Bearer [token]

Response:
{
  "success": true,
  "message": "ÄÃ£ Ä‘Ã¡nh dáº¥u táº¥t cáº£ thÃ´ng bÃ¡o lÃ  Ä‘Ã£ Ä‘á»c",
  "updatedCount": 5
}
```

#### 2.4 XÃ³a ThÃ´ng BÃ¡o

```http
DELETE /api/notifications/:id
Authorization: Bearer [token]

Response:
{
  "success": true,
  "message": "ÄÃ£ xÃ³a thÃ´ng bÃ¡o thÃ nh cÃ´ng"
}
```

#### 2.5 Gá»­i Láº¡i ThÃ´ng BÃ¡o (Admin Only)

```http
POST /api/payment/resend-notification/:paymentId
Authorization: Bearer [admin_token]

Response:
{
  "success": true,
  "message": "ÄÃ£ gá»­i láº¡i thÃ´ng bÃ¡o thÃ nh cÃ´ng",
  "notification": {
    "id": "notification_id",
    "recipient": "username",
    "title": "âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i"
  }
}
```

#### 2.6 Láº¥y Sá»‘ LÆ°á»£ng ThÃ´ng BÃ¡o ChÆ°a Äá»c

```http
GET /api/notifications/unread-count
Authorization: Bearer [token]

Response:
{
  "unreadCount": 5
}
```

---

## ğŸ“Š Database Schema

### Notification Model

```javascript
{
  user: { type: ObjectId, ref: 'User', required: true },
  type: {
    type: String,
    enum: [
      'payment-rejected',
      'payment-approved',
      'payment-pending',
      'class-enrolled',
      'class-cancelled',
      'class-reminder',
      'membership-activated',
      'membership-expiring',
      'membership-expired',
      'membership-upgraded',
      'attendance-marked',
      'attendance-missed',
      'feedback-replied',
      'new-student',        // For trainer
      'class-starting',     // For trainer
      'student-cancelled',  // For trainer
      'class-full',         // For trainer
      'attendance-reminder',// For trainer
      'schedule-changed',   // For trainer
      'schedule-approved',  // For trainer
      'schedule-rejected',  // For trainer
      'student-feedback',   // For trainer
      'system-maintenance',
      'system-update'
    ],
    required: true
  },
  title: { type: String, required: true },
  message: { type: String, required: true },
  relatedId: { type: ObjectId }, // Link to Payment, Class, Membership, etc.
  isRead: { type: Boolean, default: false },
  readAt: { type: Date },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
}
```

---

## ğŸ”„ Workflow ThÃ´ng BÃ¡o

### 1. Workflow Thanh ToÃ¡n

```
User thanh toÃ¡n
    â†“
Admin xem xÃ©t
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚                   â”‚
Cháº¥p nháº­n          Tá»« chá»‘i           Chá» xá»­ lÃ½
â”‚                   â”‚                   â”‚
â†“                   â†“                   â†“
ThÃ´ng bÃ¡o          ThÃ´ng bÃ¡o          ThÃ´ng bÃ¡o
"Thanh toÃ¡n        "Thanh toÃ¡n        "Äang xá»­ lÃ½"
thÃ nh cÃ´ng"        bá»‹ tá»« chá»‘i"
â”‚                   â”‚
â†“                   â†“
KÃ­ch hoáº¡t          Há»§y Ä‘Äƒng kÃ½
dá»‹ch vá»¥            + Gá»­i email
```

### 2. Workflow Lá»›p Há»c

```
User Ä‘Äƒng kÃ½ lá»›p
    â†“
Táº¡o enrollment (pending_payment)
    â†“
ThÃ´ng bÃ¡o cho User: "ÄÄƒng kÃ½ thÃ nh cÃ´ng, chá» thanh toÃ¡n"
    â†“
ThÃ´ng bÃ¡o cho Trainer: "Há»c viÃªn má»›i Ä‘Äƒng kÃ½"
    â†“
User thanh toÃ¡n
    â†“
Admin duyá»‡t
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚                   â”‚
Cháº¥p nháº­n          Tá»« chá»‘i
â”‚                   â”‚
â†“                   â†“
Enrollment active  Enrollment cancelled
â”‚                   â”‚
ThÃ´ng bÃ¡o User     ThÃ´ng bÃ¡o User
+ Trainer          + Trainer
```

### 3. Workflow Äiá»ƒm Danh

```
Trainer má»Ÿ buá»•i há»c
    â†“
ThÃ´ng bÃ¡o cho Trainer: "ÄÃ£ Ä‘áº¿n giá» Ä‘iá»ƒm danh"
    â†“
Trainer Ä‘iá»ƒm danh tá»«ng há»c viÃªn
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚                   â”‚
CÃ³ máº·t            Váº¯ng máº·t
â”‚                   â”‚
â†“                   â†“
ThÃ´ng bÃ¡o:         ThÃ´ng bÃ¡o:
"Äiá»ƒm danh         "Váº¯ng máº·t"
thÃ nh cÃ´ng"
    â†“
HoÃ n thÃ nh buá»•i há»c
    â†“
ThÃ´ng bÃ¡o cho Trainer: "Äiá»ƒm danh hoÃ n táº¥t"
```

---

## ğŸ” PhÃ¢n Quyá»n

### User (Member)

- âœ… Xem thÃ´ng bÃ¡o cá»§a chÃ­nh mÃ¬nh
- âœ… ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c
- âœ… XÃ³a thÃ´ng bÃ¡o
- âŒ KhÃ´ng thá»ƒ xem thÃ´ng bÃ¡o cá»§a ngÆ°á»i khÃ¡c
- âŒ KhÃ´ng thá»ƒ gá»­i thÃ´ng bÃ¡o

### Trainer

- âœ… Xem thÃ´ng bÃ¡o vá» lá»›p há»c cá»§a mÃ¬nh
- âœ… Xem thÃ´ng bÃ¡o vá» há»c viÃªn
- âœ… ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c
- âœ… XÃ³a thÃ´ng bÃ¡o
- âŒ KhÃ´ng thá»ƒ xem thÃ´ng bÃ¡o cá»§a trainer khÃ¡c

### Admin

- âœ… Gá»­i thÃ´ng bÃ¡o cho báº¥t ká»³ user nÃ o
- âœ… Gá»­i láº¡i thÃ´ng bÃ¡o
- âœ… Xem táº¥t cáº£ thÃ´ng bÃ¡o (trong admin panel)
- âœ… XÃ³a thÃ´ng bÃ¡o

---

## ğŸ¨ UI/UX Guidelines

### 1. Badge ThÃ´ng BÃ¡o

```
- Hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng thÃ´ng bÃ¡o chÆ°a Ä‘á»c
- MÃ u Ä‘á» vá»›i sá»‘ tráº¯ng
- Tá»‘i Ä‘a hiá»ƒn thá»‹ 99+
- Real-time update
```

### 2. Danh SÃ¡ch ThÃ´ng BÃ¡o

```
- ThÃ´ng bÃ¡o chÆ°a Ä‘á»c: Background mÃ u nháº¡t
- ThÃ´ng bÃ¡o Ä‘Ã£ Ä‘á»c: Background tráº¯ng
- Icon phÃ¹ há»£p vá»›i loáº¡i thÃ´ng bÃ¡o
- Thá»i gian hiá»ƒn thá»‹ dáº¡ng "5 phÃºt trÆ°á»›c", "2 giá» trÆ°á»›c"
- Swipe Ä‘á»ƒ xÃ³a
- Pull to refresh
```

### 3. Chi Tiáº¿t ThÃ´ng BÃ¡o

```
- Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ ná»™i dung
- NÃºt hÃ nh Ä‘á»™ng (náº¿u cÃ³): "Xem chi tiáº¿t", "Thanh toÃ¡n láº¡i"
- Tá»± Ä‘á»™ng Ä‘Ã¡nh dáº¥u Ä‘Ã£ Ä‘á»c khi má»Ÿ
```

### 4. Ã‚m Thanh & Rung

```
- PhÃ¡t Ã¢m thanh khi cÃ³ thÃ´ng bÃ¡o má»›i (cÃ³ thá»ƒ táº¯t)
- Rung nháº¹ khi cÃ³ thÃ´ng bÃ¡o quan trá»ng
- KhÃ¡c nhau theo loáº¡i thÃ´ng bÃ¡o
```

---

## ğŸ“± Push Notification (TÆ°Æ¡ng lai)

### Cáº¥u hÃ¬nh Firebase Cloud Messaging

```javascript
// Gá»­i push notification
const message = {
  notification: {
    title: notification.title,
    body: notification.message,
  },
  token: userDeviceToken,
  data: {
    type: notification.type,
    relatedId: notification.relatedId,
  },
};

await admin.messaging().send(message);
```

---

## ğŸ§ª Testing

### 1. Test ThÃ´ng BÃ¡o Thanh ToÃ¡n

```bash
# Táº¡o payment vÃ  tá»« chá»‘i
cd backend
node test-notification-rejection.js
```

### 2. Test ThÃ´ng BÃ¡o Lá»›p Há»c

```bash
# Test Ä‘Äƒng kÃ½ lá»›p
POST /api/classes/:classId/enroll
# Kiá»ƒm tra notification cho user vÃ  trainer
GET /api/notifications
```

### 3. Test API

```bash
# Láº¥y danh sÃ¡ch thÃ´ng bÃ¡o
GET /api/notifications

# ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c
PUT /api/notifications/:id/read

# XÃ³a thÃ´ng bÃ¡o
DELETE /api/notifications/:id
```

---

## ğŸ“ˆ Monitoring & Analytics

### Metrics cáº§n theo dÃµi

```
1. Sá»‘ lÆ°á»£ng thÃ´ng bÃ¡o Ä‘Æ°á»£c gá»­i / ngÃ y
2. Tá»· lá»‡ thÃ´ng bÃ¡o Ä‘Æ°á»£c Ä‘á»c
3. Thá»i gian trung bÃ¬nh tá»« gá»­i Ä‘áº¿n Ä‘á»c
4. ThÃ´ng bÃ¡o nÃ o Ä‘Æ°á»£c Ä‘á»c nhiá»u nháº¥t
5. ThÃ´ng bÃ¡o nÃ o bá»‹ xÃ³a nhiá»u nháº¥t
6. Lá»—i khi gá»­i thÃ´ng bÃ¡o
```

### Logging

```javascript
// Success
console.log(`âœ… Notification sent: ${type} to user ${userId}`);

// Error
console.error(`âŒ Failed to send notification: ${error.message}`);
```

---

## ğŸš€ TÃ­nh NÄƒng Má»Ÿ Rá»™ng

### 1. Email Notification

- Gá»­i email song song vá»›i in-app notification
- Cho cÃ¡c thÃ´ng bÃ¡o quan trá»ng

### 2. SMS Notification

- Cho gÃ³i VIP
- Nháº¯c nhá»Ÿ lá»›p há»c, háº¿t háº¡n tháº»

### 3. Notification Settings

- User tÃ¹y chá»‰nh loáº¡i thÃ´ng bÃ¡o muá»‘n nháº­n
- Táº¯t/Báº­t Ã¢m thanh, rung
- Chá»n thá»i gian nháº­n thÃ´ng bÃ¡o

### 4. Notification Templates

- Admin táº¡o template
- Tá»± Ä‘á»™ng Ä‘iá»n thÃ´ng tin
- A/B testing message

### 5. Real-time Notification

- WebSocket/Socket.IO
- Cáº­p nháº­t ngay láº­p tá»©c
- KhÃ´ng cáº§n reload

---

## ğŸ“š Code Examples

### Gá»­i ThÃ´ng BÃ¡o Trong Controller

```javascript
// services/NotificationService.js
async sendPaymentRejectionNotification(payment, rejectionReason) {
  const notification = await Notification.create({
    user: payment.user,
    type: 'payment-rejected',
    title: 'âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i',
    message: this.formatPaymentRejectionMessage(payment, rejectionReason),
    relatedId: payment._id
  });

  // TODO: Send push notification
  // await this.sendPushNotification(notification);

  return notification;
}
```

### Frontend - Hiá»ƒn Thá»‹ ThÃ´ng BÃ¡o

```javascript
// React/Flutter
const NotificationList = () => {
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);

  useEffect(() => {
    fetchNotifications();
    // Poll every 30 seconds
    const interval = setInterval(fetchNotifications, 30000);
    return () => clearInterval(interval);
  }, []);

  const fetchNotifications = async () => {
    const response = await api.get("/api/notifications");
    setNotifications(response.data.notifications);
    setUnreadCount(response.data.unreadCount);
  };

  const markAsRead = async (id) => {
    await api.put(`/api/notifications/${id}/read`);
    fetchNotifications();
  };

  return (
    <div>
      <Badge count={unreadCount}>
        <BellIcon />
      </Badge>
      {notifications.map((notif) => (
        <NotificationItem
          key={notif._id}
          notification={notif}
          onRead={() => markAsRead(notif._id)}
        />
      ))}
    </div>
  );
};
```

---

## âœ… Checklist Triá»ƒn Khai

- [x] Táº¡o Notification Model
- [x] API endpoints cÆ¡ báº£n
- [x] Gá»­i thÃ´ng bÃ¡o thanh toÃ¡n
- [ ] Gá»­i thÃ´ng bÃ¡o lá»›p há»c
- [ ] Gá»­i thÃ´ng bÃ¡o membership
- [ ] Gá»­i thÃ´ng bÃ¡o Ä‘iá»ƒm danh
- [ ] Frontend UI thÃ´ng bÃ¡o
- [ ] Real-time updates
- [ ] Push notifications
- [ ] Email notifications
- [ ] Notification settings
- [ ] Analytics & monitoring

---

## ğŸ“ Support

LiÃªn há»‡ team dev náº¿u cáº§n há»— trá»£ vá» há»‡ thá»‘ng thÃ´ng bÃ¡o.

## Cáº¥u trÃºc thÃ´ng bÃ¡o

### TiÃªu Ä‘á»

```
âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i
```

### Ná»™i dung thÃ´ng bÃ¡o

```
ğŸ’° Thanh toÃ¡n [sá»‘ tiá»n]Ä‘ cá»§a báº¡n Ä‘Ã£ bá»‹ tá»« chá»‘i.

ğŸ“ LÃ½ do tá»« chá»‘i: [lÃ½ do cá»¥ thá»ƒ]

[ThÃ´ng tin chi tiáº¿t theo loáº¡i Ä‘Äƒng kÃ½]

ğŸ”„ HÃ nh Ä‘á»™ng tiáº¿p theo:
[HÆ°á»›ng dáº«n cá»¥ thá»ƒ cho tá»«ng loáº¡i]

ğŸ“ Há»— trá»£: [ThÃ´ng tin liÃªn há»‡]
```

### PhÃ¢n biá»‡t theo loáº¡i Ä‘Äƒng kÃ½

#### Class Registration

```
ğŸ“ ÄÄƒng kÃ½ lá»›p há»c cá»§a báº¡n Ä‘Ã£ bá»‹ há»§y bá».
ğŸ”„ Báº¡n cÃ³ thá»ƒ Ä‘Äƒng kÃ½ láº¡i lá»›p há»c nÃ y hoáº·c chá»n lá»›p khÃ¡c phÃ¹ há»£p.
```

#### Membership

```
ğŸ’³ GÃ³i thÃ nh viÃªn cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t láº¡i tráº¡ng thÃ¡i chá» thanh toÃ¡n.
ğŸ”„ Báº¡n cÃ³ thá»ƒ thá»±c hiá»‡n thanh toÃ¡n láº¡i Ä‘á»ƒ kÃ­ch hoáº¡t gÃ³i thÃ nh viÃªn.
```

#### Mixed (Membership + Class)

```
ğŸ“‹ ÄÄƒng kÃ½ gÃ³i thÃ nh viÃªn vÃ  lá»›p há»c Ä‘Ã£ Ä‘Æ°á»£c khÃ´i phá»¥c vá» tráº¡ng thÃ¡i ban Ä‘áº§u.
ğŸ”„ Báº¡n cÃ³ thá»ƒ Ä‘Äƒng kÃ½ láº¡i hoáº·c liÃªn há»‡ admin Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£.
```

## API Endpoints

### 1. Tá»« chá»‘i thanh toÃ¡n (cÃ³ thÃ´ng bÃ¡o)

```http
PUT /api/payment/reject/:paymentId
Authorization: Bearer [admin_token]
Content-Type: application/json

{
  "rejectionReason": "ThÃ´ng tin chuyá»ƒn khoáº£n khÃ´ng chÃ­nh xÃ¡c"
}
```

**Response:**

```json
{
  "message": "Tá»« chá»‘i thanh toÃ¡n thÃ nh cÃ´ng",
  "payment": {...},
  "updateResults": [...],
  "notification": {
    "sent": true,
    "message": "ÄÃ£ gá»­i thÃ´ng bÃ¡o chi tiáº¿t cho ngÆ°á»i dÃ¹ng",
    "error": null
  }
}
```

### 2. Gá»­i láº¡i thÃ´ng bÃ¡o

```http
POST /api/payment/resend-notification/:paymentId
Authorization: Bearer [admin_token]
```

**Response:**

```json
{
  "success": true,
  "message": "ÄÃ£ gá»­i láº¡i thÃ´ng bÃ¡o thÃ nh cÃ´ng",
  "notification": {
    "id": "notification_id",
    "recipient": "username",
    "title": "âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i"
  }
}
```

### 3. Láº¥y thÃ´ng bÃ¡o cá»§a user

```http
GET /api/notifications
Authorization: Bearer [user_token]
```

**Response:**

```json
{
  "notifications": [
    {
      "_id": "notification_id",
      "title": "âš ï¸ YÃªu cáº§u thanh toÃ¡n bá»‹ tá»« chá»‘i",
      "message": "...",
      "type": "payment-rejected",
      "isRead": false,
      "createdAt": "2025-10-09T...",
      "relatedId": "payment_id"
    }
  ],
  "unreadCount": 3
}
```

## Database

### Notification Model

- âœ… ÄÃ£ thÃªm type `"payment-rejected"` vÃ o enum
- âœ… LÆ°u relatedId Ä‘á»ƒ link vá»›i payment
- âœ… Track tráº¡ng thÃ¡i Ä‘á»c/chÆ°a Ä‘á»c

### Payment Model

- âœ… LÆ°u `rejectionReason`, `rejectedAt`, `rejectedBy`
- âœ… Status `"cancelled"` cho payment bá»‹ tá»« chá»‘i

## Workflow hoÃ n chá»‰nh

### 1. Admin tá»« chá»‘i payment

```
Admin â†’ API reject â†’ Payment status = cancelled â†’
Registrations reset â†’ Notification sent â†’ User notified
```

### 2. User nháº­n thÃ´ng bÃ¡o

```
User â†’ Check notifications â†’ See rejection â†’
Understand reason â†’ Take action (re-register/contact admin)
```

### 3. Error handling

```
Notification failed â†’ Log error â†’ Continue process â†’
Admin can resend notification later
```

## Testing

### 1. Manual Test

```bash
# Táº¡o payment pending
POST /api/payment

# Admin tá»« chá»‘i
PUT /api/payment/reject/:id

# Check user notifications
GET /api/notifications

# Resend notification náº¿u cáº§n
POST /api/payment/resend-notification/:id
```

### 2. Script Test

```bash
cd backend
node test-notification-rejection.js
```

### 3. Debug Routes

```bash
# Check pending payments
GET /api/debug/pending-payments

# Check specific payment
GET /api/debug/test-payment-rejection/:id
```

## Monitoring & Logs

### Successful notification

```
âœ… Payment rejection notification sent successfully to user: username - Notification ID: xxx
```

### Failed notification

```
âŒ Error sending payment rejection notification: error_details
```

### Resend notification

```
âœ… Payment rejection notification resent successfully to user: username - Notification ID: xxx
```

## Security

- âœ… Chá»‰ admin cÃ³ thá»ƒ tá»« chá»‘i payment vÃ  gá»­i láº¡i thÃ´ng bÃ¡o
- âœ… Validate payment ID vÃ  tráº¡ng thÃ¡i
- âœ… User chá»‰ nháº­n thÃ´ng bÃ¡o cá»§a chÃ­nh mÃ¬nh
- âœ… KhÃ´ng expose sensitive payment info trong notification

## Performance

- âœ… Notification gá»­i báº¥t Ä‘á»“ng bá»™, khÃ´ng block reject process
- âœ… Error trong notification khÃ´ng lÃ m fail reject payment
- âœ… CÃ³ thá»ƒ gá»­i láº¡i notification náº¿u tháº¥t báº¡i
- âœ… Log Ä‘áº§y Ä‘á»§ Ä‘á»ƒ monitoring

## User Experience

- âœ… ThÃ´ng bÃ¡o thÃ¢n thiá»‡n vá»›i emoji
- âœ… Giáº£i thÃ­ch rÃµ rÃ ng Ä‘iá»u gÃ¬ Ä‘Ã£ xáº£y ra
- âœ… HÆ°á»›ng dáº«n bÆ°á»›c tiáº¿p theo
- âœ… ThÃ´ng tin liÃªn há»‡ há»— trá»£
- âœ… PhÃ¢n biá»‡t loáº¡i Ä‘Äƒng kÃ½ Ä‘á»ƒ thÃ´ng bÃ¡o phÃ¹ há»£p
